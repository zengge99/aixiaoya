name: 导出ONNX并跨架构打包（原生运行器版）
on:
  workflow_dispatch:

jobs:
  # ========== 第一阶段：在 amd64 上导出 ONNX（作为公共资产） ==========
  export-assets:
    name: 导出公共资产 (ONNX/Vocab)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 设置 Python 并导出
        run: |
          sudo apt-get update && sudo apt-get install -y python3-pip
          pip install --no-cache-dir torch tqdm numpy onnxscript onnxruntime
          python export_onnx.py
          mkdir -p common_files
          cp movie_extractor.onnx* vocab.pkl common_files/ 2>/dev/null || true
      - name: 暂存资产
        uses: actions/upload-artifact@v4
        with:
          name: common-assets
          path: common_files/

  # ========== 第二阶段：并行原生构建（使用原生 ARM 运行器） ==========
  build-binary:
    name: 构建 ${{ matrix.arch }} 架构
    needs: export-assets
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest       # 标准 x86 运行器
          - arch: arm64
            runner: ubuntu-24.04-arm64 # 关键：GitHub 官方原生 ARM 运行器
    
    runs-on: ${{ matrix.runner }}

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 下载公共资产 (ONNX)
        uses: actions/download-artifact@v4
        with:
          name: common-assets
          path: ./common_files

      - name: 原生环境打包 (Docker)
        run: |
          # 既然是原生运行器，Dockerfile 内部不需要任何 cross-platform 逻辑
          # 构建过程会自动匹配宿主机架构
          cat > Dockerfile.${{ matrix.arch }} << EOF
          FROM python:3.12-slim
          WORKDIR /app
          RUN apt-get update && apt-get install -y --no-install-recommends \
              gcc g++ && rm -rf /var/lib/apt/lists/*
          RUN pip install --upgrade pip setuptools wheel
          COPY . .
          # 将下载的 assets 放入正确位置
          COPY ./common_files/ /app/
          RUN pip install --no-cache-dir --only-binary=all onnxruntime pyinstaller
          RUN pyinstaller --onefile --name movie_extractor_${{ matrix.arch }} --clean infer_onnx.py
          
          # 准备输出目录
          RUN mkdir -p /export && \
              cp dist/movie_extractor_${{ matrix.arch }} /export/ && \
              cp /app/common_files/movie_extractor.onnx* /export/ 2>/dev/null || true && \
              cp /app/common_files/vocab.pkl /export/ 2>/dev/null || true
          EOF

          # 直接构建，无需 buildx qemu，速度极快
          docker build -t builder-${{ matrix.arch }} -f Dockerfile.${{ matrix.arch }} .
          
          # 将产物从镜像提取到宿主机
          mkdir -p ./release/${{ matrix.arch }}
          docker run --rm -v $(pwd)/release/${{ matrix.arch }}:/out builder-${{ matrix.arch }} cp -r /export/. /out/

      - name: 验证并上传
        run: |
          ls -R ./release/${{ matrix.arch }}
          file ./release/${{ matrix.arch }/movie_extractor_${{ matrix.arch }}
        shell: bash

      - name: 上传单架构产物
        uses: actions/upload-artifact@v4
        with:
          name: raw-bin-${{ matrix.arch }}
          path: release/${{ matrix.arch }}/

  # ========== 第三阶段：合并与部署 ==========
  deploy:
    name: 合并产物并推送到仓库
    runs-on: ubuntu-latest
    needs: build-binary
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: 下载所有产物
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: 整理并压缩
        run: |
          mkdir -p release/amd64 release/arm64
          # 从下载的目录移动到最终结构
          cp -r all_artifacts/raw-bin-amd64/* release/amd64/
          cp -r all_artifacts/raw-bin-arm64/* release/arm64/
          
          cd release
          zip -r movie_extractor_amd64.zip amd64/
          zip -r movie_extractor_arm64.zip arm64/
          cd ..
          ls -R release/

      - name: 推送至仓库
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add release/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "dist: 自动更新多架构产物 (native build)"
            git push origin main
          fi