name: 导出ONNX并跨架构打包（推送到仓库）
on:
  workflow_dispatch:

jobs:
  # ========== 第一阶段：并行构建各架构产物 ==========
  build-cross-arch:
    name: 构建 ${{ matrix.arch }} 架构
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: 拉取仓库代码（含完整历史）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 设置Docker Buildx（核心跨架构支持）
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: 安装QEMU跨架构支持
        uses: docker/setup-qemu-action@v3

      # ========== 核心修改：多阶段构建+仅导出指定文件 ==========
      - name: 跨架构打包（含ONNX导出）
        run: |
          # 创建多阶段Dockerfile，仅保留需要的产物
          cat > Dockerfile.${{ matrix.arch }} << EOF
          # 第一阶段：构建阶段（完成编译、导出逻辑）
          FROM python:3.12-slim AS builder
          WORKDIR /app
          ARG ARCH
          # 安装基础依赖
          RUN apt-get update && apt-get install -y --no-install-recommends \
              gcc \
              g++ \
              && rm -rf /var/lib/apt/lists/*
          # 复制代码到容器
          COPY . .
          # 第一步：安装打包依赖并打包可执行文件
          RUN pip uninstall -y torch || true \
              && pip install --no-cache-dir onnxruntime pyinstaller \
              && pyinstaller --onefile --name movie_extractor_\${ARCH} --clean infer_onnx.py
          # 第二步：安装导出依赖并导出ONNX
          RUN pip install --no-cache-dir torch tqdm numpy onnxscript \
              && python export_onnx.py
          # 整理产物到统一目录
          RUN mkdir -p /app/release/\${ARCH} \
              && cp /app/dist/movie_extractor_\${ARCH} /app/release/\${ARCH}/ || true \
              && cp /app/movie_extractor.onnx* /app/release/\${ARCH}/ 2>/dev/null || true \
              && cp /app/vocab.pkl /app/release/\${ARCH}/ 2>/dev/null || true

          # 第二阶段：仅用于导出指定文件（空白镜像，最小化体积）
          FROM scratch AS export-stage
          ARG ARCH
          # 只复制需要的产物，排除所有冗余内容
          COPY --from=builder /app/release/\${ARCH}/movie_extractor_\${ARCH} /\${ARCH}/
          COPY --from=builder /app/release/\${ARCH}/movie_extractor.onnx* /\${ARCH}/
          COPY --from=builder /app/release/\${ARCH}/vocab.pkl /\${ARCH}/
          EOF

          # 使用buildx构建并仅导出export-stage的指定文件
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg ARCH=${{ matrix.arch }} \
            -f Dockerfile.${{ matrix.arch }} \
            --target export-stage \  # 仅构建导出阶段
            --output type=local,dest=./release \  # 导出到release目录
            .

          # 验证产物是否存在
          if [ -f "release/${{ matrix.arch }}/movie_extractor_${{ matrix.arch }}" ]; then
            echo "✅ ${{ matrix.arch }} 架构产物存在："
            ls -l release/${{ matrix.arch }}/
            file release/${{ matrix.arch }}/movie_extractor_${{ matrix.arch }}
          else
            echo "❌ ${{ matrix.arch }} 架构产物不存在"
            exit 1
          fi
        shell: bash

      # ========== 上传仅包含指定文件的产物 ==========
      - name: 上传${{ matrix.arch }}架构产物
        uses: actions/upload-artifact@v4
        with:
          name: movie_extractor_${{ matrix.arch }}_raw
          path: release/${{ matrix.arch }}/
          if-no-files-found: error

  # ========== 第二阶段：串行合并产物并提交 ==========
  deploy:
    name: 合并产物并推送到仓库
    runs-on: ubuntu-latest
    needs: build-cross-arch
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 创建最终release目录
        run: mkdir -p release
        shell: bash

      - name: 下载amd64架构产物
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_amd64_raw
          path: release/amd64

      - name: 下载arm64架构产物
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_arm64_raw
          path: release/arm64

      - name: 打包ZIP文件
        run: |
          # 为每个架构创建ZIP包
          cd release
          zip -r movie_extractor_amd64.zip amd64/
          zip -r movie_extractor_arm64.zip arm64/
          cd ..
          # 验证ZIP包
          ls -l release/
        shell: bash

      - name: 推送产物到仓库
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add release/
          git status
          
          if git diff --cached --quiet; then
            echo "⚠️  无新产物需要提交"
          else
            git commit -m "chore: 新增amd64/arm64架构打包产物（含ZIP包） $(date +%Y%m%d_%H%M%S)"
            git push origin main
            echo "✅ 产物已推送到仓库release目录"
          fi
        shell: bash