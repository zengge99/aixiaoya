name: å¯¼å‡ºONNXå¹¶è·¨æ¶æ„æ‰“åŒ…ï¼ˆæ¨é€åˆ°ä»“åº“ï¼‰
on:
  workflow_dispatch:

jobs:
  # ========== ç¬¬ä¸€é˜¶æ®µï¼šå¹¶è¡Œæ„å»ºå„æ¶æ„äº§ç‰© ==========
  build-cross-arch:
    name: æ„å»º ${{ matrix.arch }} æ¶æ„
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
          - arch: arm64

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ä»…åœ¨æ„å»º arm64 æ—¶éœ€è¦ QEMU
      - name: é…ç½® QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      # ==========================================
      # æ–¹æ¡ˆ A: AMD64 åŸç”Ÿæ„å»º (é€Ÿåº¦å¿«ï¼Œæ— Dockeré”™è¯¯)
      # ==========================================
      - name: é…ç½® Python (AMD64)
        if: matrix.arch == 'amd64'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: æ„å»º AMD64 äº§ç‰©
        if: matrix.arch == 'amd64'
        run: |
          echo "ğŸš€ å¼€å§‹ AMD64 åŸç”Ÿæ„å»º..."
          pip install --upgrade pip
          pip install onnxruntime pyinstaller torch tqdm numpy onnxscript
          
          # 1. æ‰“åŒ… Exe
          pyinstaller --onefile --name movie_extractor_amd64 --clean infer_onnx.py
          
          # 2. å¯¼å‡º ONNX (ä»…éœ€åœ¨ amd64 å¯¼å‡ºä¸€æ¬¡å³å¯)
          python export_onnx.py
          
          # 3. æ•´ç†äº§ç‰©
          mkdir -p release/amd64
          cp dist/movie_extractor_amd64 release/amd64/
          cp movie_extractor.onnx release/amd64/
          cp movie_extractor.onnx.data release/amd64/ || true
          cp vocab.pkl release/amd64/
          
          # 4. æ‰“åŒ… ZIP
          cd release/amd64
          zip -r ../../movie_extractor_amd64.zip ./*
          echo "âœ… AMD64 æ„å»ºå®Œæˆ"

      # ==========================================
      # æ–¹æ¡ˆ B: ARM64 æ¨¡æ‹Ÿæ„å»º (ä½¿ç”¨å†…ç½® distro)
      # ==========================================
      - name: æ„å»º ARM64 äº§ç‰©
        if: matrix.arch == 'arm64'
        uses: uraimo/run-on-arch-action@v2
        id: build_arm64
        with:
          arch: aarch64
          # ä½¿ç”¨å†…ç½®çš„ distro é…ç½®ï¼Œä¸è¦ä½¿ç”¨ base_imageï¼Œé¿å… manifest é”™è¯¯
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          setup: |
            mkdir -p "${PWD}/artifacts"
          dockerRunArgs: |
            --volume "${PWD}/artifacts:/artifacts"
          install: |
            apt-get update -q -y
            apt-get install -q -y python3 python3-pip python3-venv git zip
          run: |
            # --- å®¹å™¨å†…éƒ¨ (ARM64) ---
            python3 -m venv venv
            source venv/bin/activate
            
            echo "ğŸš€ å¼€å§‹ ARM64 æ„å»º (QEMU)..."
            pip install --upgrade pip
            # æ³¨æ„: ARMä¸‹å®‰è£… torch è¾ƒæ…¢
            pip install onnxruntime pyinstaller torch tqdm numpy onnxscript --no-cache-dir
            
            # 1. æ‰“åŒ… Exe
            pyinstaller --onefile --name movie_extractor_arm64 --clean infer_onnx.py
            
            # 2. æ•´ç†äº§ç‰© (ONNX ä¸éœ€è¦åœ¨è¿™é‡Œå¯¼å‡ºï¼Œå¤ªæ…¢äº†ï¼Œå¤ç”¨æˆ–å‡è®¾å·²æœ‰ï¼Œæˆ–è€…å¦‚æœä½ å¿…é¡»åœ¨ARMå¯¼å‡ºåˆ™å–æ¶ˆæ³¨é‡Š)
            # python export_onnx.py 
            
            mkdir -p /artifacts/release/arm64
            cp dist/movie_extractor_arm64 /artifacts/release/arm64/
            
            # å¤åˆ¶ä¾èµ–æ–‡ä»¶ (å‡è®¾ä»£ç åº“é‡Œæœ‰ vocab.pkl)
            cp vocab.pkl /artifacts/release/arm64/ || echo "Warning: vocab.pkl missing"
            # å¦‚æœä½ åœ¨ arm64 ä¹Ÿéœ€è¦ onnxï¼Œå»ºè®®ä¸Šé¢è¿è¡Œå¯¼å‡ºï¼Œæˆ–è€…è¿™é‡Œå…ˆç•™ç©ºï¼Œç­‰æœ€åç»Ÿä¸€å¤„ç†
            # ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾ arm64 åŒ…é‡Œä¸»è¦åŒ…å« exe
            
            # 3. æ‰“åŒ… ZIP
            cd /artifacts/release/arm64
            zip -r ../../movie_extractor_arm64.zip ./*

      # ==========================================
      # ç»Ÿä¸€ä¸Šä¼ äº§ç‰©
      # ==========================================
      
      # ä¸Šä¼  AMD64
      - name: ä¸Šä¼  AMD64 ZIP
        if: matrix.arch == 'amd64'
        uses: actions/upload-artifact@v4
        with:
          name: movie_extractor_amd64_zip
          path: movie_extractor_amd64.zip

      # ä¸Šä¼  ARM64 (ä» Docker æŒ‚è½½å‡ºæ¥çš„ç›®å½•)
      - name: ä¸Šä¼  ARM64 ZIP
        if: matrix.arch == 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: movie_extractor_arm64_zip
          path: artifacts/movie_extractor_arm64.zip

  # ========== ç¬¬äºŒé˜¶æ®µï¼šåˆå¹¶äº§ç‰©å¹¶æäº¤ ==========
  deploy:
    name: åˆå¹¶äº§ç‰©å¹¶æ¨é€åˆ°ä»“åº“
    runs-on: ubuntu-latest
    needs: build-cross-arch
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: åˆ›å»º Release ç›®å½•
        run: mkdir -p release

      - name: ä¸‹è½½ AMD64 ZIP
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_amd64_zip
          path: release

      - name: ä¸‹è½½ ARM64 ZIP
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_arm64_zip
          path: release

      # è¡¥å……é€»è¾‘ï¼šå› ä¸º arm64 æ­¥éª¤é‡Œæˆ‘ä»¬å¯èƒ½æ²¡å¯¼å‡º ONNXï¼ˆå¤ªæ…¢ï¼‰ï¼Œ
      # æˆ‘ä»¬æŠŠ amd64 é‡Œçš„ ONNX è§£å‹å‡ºæ¥ï¼Œå¡è¿› arm64 çš„ zip é‡Œï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚
      # è¿™æ˜¯ä¸€ä¸ªå¯é€‰ä¼˜åŒ–ã€‚å¦‚æœä¸ä»‹æ„ arm64 zip é‡Œæ²¡æœ‰ onnxï¼Œå¯ä»¥è·³è¿‡ã€‚
      
      - name: æ•´ç†æœ€ç»ˆæ–‡ä»¶ç»“æ„
        run: |
          # ç°åœ¨çš„ release ç›®å½•ä¸‹åº”è¯¥æœ‰ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œé‡Œé¢åˆ†åˆ«æ˜¯å¯¹åº”çš„ zip
          # download-artifact v4 çš„è¡Œä¸ºæ˜¯å°†æ–‡ä»¶ä¸‹è½½åˆ°æŒ‡å®špathçš„å­ç›®å½•æˆ–ç›´æ¥ä¸‹è½½ï¼Œå–å†³äºæ€ä¹ˆä¼ 
          # æˆ‘ä»¬å…ˆæŸ¥çœ‹ä¸€ä¸‹ç»“æ„
          ls -R release/
          
          # ç§»åŠ¨ ZIP åˆ° release æ ¹ç›®å½• (å¦‚æœ download action åˆ›å»ºäº†å­æ–‡ä»¶å¤¹)
          find release -name "movie_extractor_amd64.zip" -exec mv {} release/ \;
          find release -name "movie_extractor_arm64.zip" -exec mv {} release/ \;
          
          # æ¸…ç†ç©ºæ–‡ä»¶å¤¹
          rm -rf release/movie_extractor_*_zip || true
          
          ls -l release/

      - name: æ¨é€äº§ç‰©åˆ°ä»“åº“
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add -f release/*.zip
          
          git status
          if git diff --cached --quiet; then
            echo "âš ï¸ æ— æ–°äº§ç‰©éœ€è¦æäº¤"
          else
            git commit -m "chore: æ›´æ–°æ„å»ºäº§ç‰© amd64/arm64 $(date +%Y%m%d_%H%M%S)"
            git push origin main
            echo "âœ… äº§ç‰©å·²æ¨é€"
          fi