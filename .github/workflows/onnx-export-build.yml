name: 导出ONNX并跨架构打包
on:
  workflow_dispatch: # 仅手动触发

jobs:
  build-cross-arch:
    name: 构建 ${{ matrix.arch }} 架构
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装QEMU跨架构支持
        uses: docker/setup-qemu-action@v3

      - name: 配置Python（关闭缓存，避免依赖检查）
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: '' # 关键：空值关闭依赖缓存，彻底跳过检查

      # ========== 第一步：导出ONNX模型（纯pip，无需pipenv） ==========
      - name: 第一步-安装导出依赖+导出ONNX
        run: |
          # 升级pip，安装导出所需依赖
          python -m pip install --upgrade pip
          pip install torch tqdm numpy onnxscript --no-cache-dir
          # 执行导出脚本
          python export_onnx.py
        shell: bash

      # ========== 第二步：打包可执行文件（纯pip，卸载torch减小体积） ==========
      - name: 第二步-安装打包依赖+PyInstaller打包
        run: |
          # 卸载torch，清理冗余依赖
          pip uninstall torch -y
          # 安装打包依赖
          pip install onnxruntime pyinstaller --no-cache-dir
          # 执行打包（指定架构名称）
          pyinstaller --onefile --name movie_extractor_${{ matrix.arch }} --clean infer_onnx.py
        shell: bash

      # 上传产物（包含可执行文件+ONNX模型+词表）
      - name: 上传${{ matrix.arch }}架构产物
        uses: actions/upload-artifact@v4
        with:
          name: movie_extractor_${{ matrix.arch }}
          path:
            dist/movie_extractor_${{ matrix.arch }}
            movie_extractor.onnx
            vocab.pkl