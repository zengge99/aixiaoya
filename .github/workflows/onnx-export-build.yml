name: 导出ONNX并跨架构打包（推送到仓库）
on:
  workflow_dispatch:

jobs:
  # ========== 第一阶段：并行构建各架构产物 ==========
  build-cross-arch:
    name: 构建 ${{ matrix.arch }} 架构
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: 拉取仓库代码（含完整历史）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 设置Docker Buildx（核心跨架构支持）
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: 安装QEMU跨架构支持
        uses: actions/setup-qemu-action@v3

      # ========== 核心修改：使用Docker容器进行跨架构打包 ==========
      - name: 跨架构打包（含ONNX导出）
        run: |
          # 创建临时Dockerfile用于跨架构构建
          cat > Dockerfile.${{ matrix.arch }} << 'EOF'
          FROM python:3.12-slim
          WORKDIR /app
          # 安装基础依赖
          RUN apt-get update && apt-get install -y --no-install-recommends \
              gcc \
              g++ \
              && rm -rf /var/lib/apt/lists/*
          # 复制代码到容器
          COPY . .
          # 第一步：安装打包依赖并打包可执行文件
          RUN pip uninstall -y torch || true \
              && pip install --no-cache-dir onnxruntime pyinstaller \
              && pyinstaller --onefile --name movie_extractor_${ARCH} --clean infer_onnx.py
          # 第二步：安装导出依赖并导出ONNX
          RUN pip install --no-cache-dir torch tqdm numpy onnxscript \
              && python export_onnx.py
          # 整理产物
          RUN mkdir -p /app/release/${ARCH} \
              && cp /app/dist/movie_extractor_${ARCH} /app/release/${ARCH}/ \
              && cp /app/movie_extractor.onnx* /app/release/${ARCH}/ 2>/dev/null || true \
              && cp /app/vocab.pkl /app/release/${ARCH}/ 2>/dev/null || true
          EOF

          # 使用buildx构建跨架构镜像并导出产物
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --build-arg ARCH=${{ matrix.arch }} \
            -f Dockerfile.${{ matrix.arch }} \
            --output type=local,dest=./ \
            .

          # 验证产物架构
          if [ -f "release/${{ matrix.arch }}/movie_extractor_${{ matrix.arch }}" ]; then
            echo "✅ 产物文件存在，验证架构："
            file release/${{ matrix.arch }}/movie_extractor_${{ matrix.arch }}
          else
            echo "❌ 产物文件不存在"
            exit 1
          fi
        shell: bash

      # ========== 上传原始产物 ==========
      - name: 上传${{ matrix.arch }}架构原始产物
        uses: actions/upload-artifact@v4
        with:
          name: movie_extractor_${{ matrix.arch }}_raw
          path: release/${{ matrix.arch }}/
          if-no-files-found: error

  # ========== 第二阶段：串行合并产物并提交 ==========
  deploy:
    name: 合并产物并推送到仓库
    runs-on: ubuntu-latest
    needs: build-cross-arch
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 创建最终release目录
        run: mkdir -p release
        shell: bash

      - name: 下载amd64架构产物
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_amd64_raw
          path: release/amd64

      - name: 下载arm64架构产物
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_arm64_raw
          path: release/arm64

      - name: 打包ZIP文件
        run: |
          # 为每个架构创建ZIP包
          cd release
          zip -r movie_extractor_amd64.zip amd64/
          zip -r movie_extractor_arm64.zip arm64/
          cd ..
          # 验证ZIP包
          ls -l release/
        shell: bash

      - name: 推送产物到仓库
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add release/
          git status
          
          if git diff --cached --quiet; then
            echo "⚠️  无新产物需要提交"
          else
            git commit -m "chore: 新增amd64/arm64架构打包产物（含ZIP包） $(date +%Y%m%d_%H%M%S)"
            git push origin main
            echo "✅ 产物已推送到仓库release目录"
          fi
        shell: bash