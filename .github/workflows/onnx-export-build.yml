name: 导出ONNX并跨架构打包（推送到仓库）
on:
  workflow_dispatch:

jobs:
  # ========== 第一阶段：并行构建各架构产物 ==========
  build-cross-arch:
    name: 构建 ${{ matrix.arch }} 架构
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: 拉取仓库代码（含完整历史）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 设置Docker Buildx（支持多架构构建）
        uses: docker/setup-buildx-action@v3

      - name: 安装QEMU跨架构支持
        uses: docker/setup-qemu-action@v3

      # ========== 核心修改：使用Docker构建跨架构可执行文件 ==========
      - name: 构建${{ matrix.arch }}架构可执行文件（Docker内）
        run: |
          # 创建临时Dockerfile用于构建
          cat > Dockerfile.${{ matrix.arch }} << EOF
          FROM --platform=${{ matrix.platform }} python:3.12-slim
          WORKDIR /app
          COPY . .
          # 安装打包依赖
          RUN pip uninstall -y torch && \
              pip install onnxruntime pyinstaller --no-cache-dir && \
              # 执行打包
              pyinstaller --onefile --name movie_extractor_${{ matrix.arch }} --clean infer_onnx.py && \
              # 验证产物
              ls -l dist/
          EOF

          # 构建Docker镜像并导出可执行文件
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f Dockerfile.${{ matrix.arch }} \
            -o type=local,dest=./docker_out .

          # 验证导出的可执行文件
          if [ -f "docker_out/dist/movie_extractor_${{ matrix.arch }}" ]; then
            echo "✅ ${{ matrix.arch }}架构可执行文件构建成功"
            # 检查文件架构
            file docker_out/dist/movie_extractor_${{ matrix.arch }}
            mkdir -p dist
            cp docker_out/dist/movie_extractor_${{ matrix.arch }} dist/
          else
            echo "❌ ${{ matrix.arch }}架构可执行文件构建失败"
            ls -l docker_out/
            exit 1
          fi
        shell: bash

      # ========== 导出ONNX模型（宿主机执行，模型文件跨架构通用） ==========
      - name: 导出ONNX模型
        run: |
          # 配置Python环境
          python -m pip install --upgrade pip
          pip install torch tqdm numpy onnxscript --no-cache-dir
          # 执行导出脚本
          python export_onnx.py || { echo "导出ONNX失败！"; ls -l; exit 1; }
          # 验证ONNX生成
          if [ -f "movie_extractor.onnx" ]; then
            echo "✅ ONNX模型生成成功"
          else
            echo "❌ ONNX模型未生成"
            ls -l
          fi
        shell: bash

      # ========== 准备产物目录（按架构分类子目录） ==========
      - name: 整理产物到架构子目录
        run: |
          # 创建架构专属子目录
          mkdir -p release/${{ matrix.arch }}
          # 复制可执行文件
          cp dist/movie_extractor_${{ matrix.arch }} release/${{ matrix.arch }}/
          # 复制ONNX相关文件
          for file in movie_extractor.onnx movie_extractor.onnx.data vocab.pkl; do
            if [ -f "$file" ]; then
              cp "$file" release/${{ matrix.arch }}/
              echo "✅ 已复制$file到release/${{ matrix.arch }}目录"
            else
              echo "⚠️  $file不存在，跳过复制"
            fi
          done
          # 查看整理结果
          ls -l release/${{ matrix.arch }}/
          # 验证可执行文件架构
          file release/${{ matrix.arch }}/movie_extractor_${{ matrix.arch }}
        shell: bash

      # ========== 上传原始产物 ==========
      - name: 上传${{ matrix.arch }}架构原始产物
        uses: actions/upload-artifact@v4
        with:
          name: movie_extractor_${{ matrix.arch }}_raw
          path: release/${{ matrix.arch }}/
          if-no-files-found: error

  # ========== 第二阶段：串行合并产物并提交 ==========
  deploy:
    name: 合并产物并推送到仓库
    runs-on: ubuntu-latest
    needs: build-cross-arch
    steps:
      - name: 拉取仓库代码（含完整历史）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 创建最终release目录
        run: mkdir -p release
        shell: bash

      - name: 下载amd64架构原始产物
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_amd64_raw
          path: release/amd64

      - name: 下载arm64架构原始产物
        uses: actions/download-artifact@v4
        with:
          name: movie_extractor_arm64_raw
          path: release/arm64

      # ========== 生成ZIP包（修复原curl方式的问题） ==========
      - name: 为各架构生成ZIP包
        run: |
          # 为amd64生成ZIP
          cd release/amd64 && zip -r ../movie_extractor_amd64.zip . && cd -
          # 为arm64生成ZIP
          cd release/arm64 && zip -r ../movie_extractor_arm64.zip . && cd -
          # 验证ZIP包
          ls -l release/
        shell: bash

      # ========== 推送合并后的产物到仓库 ==========
      - name: 推送产物到仓库
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # 添加所有release目录下的文件
          git add release/
          git status
          # 提交并推送（无变更则跳过）
          if git diff --cached --quiet; then
            echo "⚠️  无新产物需要提交"
          else
            git commit -m "chore: 新增amd64/arm64架构打包产物（含ZIP包） $(date +%Y%m%d_%H%M%S)"
            git push origin main
            echo "✅ 产物已推送到仓库release目录"
          fi
        shell: bash