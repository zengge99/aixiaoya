name: 单文件二进制打包
on:
  workflow_dispatch:

jobs:
  # ========== 第一阶段：导出 ONNX (公共资源) ==========
  prepare-assets:
    name: 导出公共模型资源
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装导出环境
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends python3-pip
          pip install --upgrade pip setuptools wheel
          pip install --no-cache-dir --only-binary=all torch tqdm numpy onnxscript onnxruntime

      - name: 执行导出脚本
        run: |
          python export_onnx.py
          mkdir -p ./common_files
          cp movie_extractor.onnx* ./common_files/
          cp vocab.pkl ./common_files/

      - name: 上传临时资源
        uses: actions/upload-artifact@v4
        with:
          name: common-assets
          path: ./common_files/
          retention-days: 1

  # ========== 第二阶段：并行构建内嵌资源的单文件 ==========
  build-cross-arch:
    name: 构建 ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: prepare-assets
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 下载公共模型资源
        uses: actions/download-artifact@v4
        with:
          name: common-assets
          path: ./common_files

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 安装 QEMU 支持
        uses: docker/setup-qemu-action@v3

      - name: 跨架构打包 (资源内嵌)
        run: |
          cat > Dockerfile.${{ matrix.arch }} << EOF
          FROM python:3.12-slim AS builder
          WORKDIR /app
          RUN apt-get update && apt-get install -y --no-install-recommends gcc g++ && rm -rf /var/lib/apt/lists/*
          RUN pip install --upgrade pip setuptools wheel
          RUN pip install --no-cache-dir --only-binary=all onnxruntime pyinstaller
          
          COPY . .
          COPY ./common_files/* . 

          # 打包命令：内嵌所有模型文件
          RUN pyinstaller --onefile --clean \
              --name movie_extractor_${{ matrix.arch }} \
              --add-data "movie_extractor.onnx:." \
              --add-data "movie_extractor.onnx.data:." \
              --add-data "vocab.pkl:." \
              infer_onnx.py

          FROM scratch AS export-stage
          ARG ARCH
          COPY --from=builder /app/dist/movie_extractor_${{ matrix.arch }} /output/
          EOF

          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f Dockerfile.${{ matrix.arch }} \
            --target export-stage \
            --output type=local,dest=. \
            --load .

      - name: 上传单文件
        uses: actions/upload-artifact@v4
        with:
          name: binary_${{ matrix.arch }}
          path: output/movie_extractor_${{ matrix.arch }}
          retention-days: 1

  # ========== 第三阶段：整理并推送到仓库 ==========
  deploy:
    name: 推送产物
    runs-on: ubuntu-latest
    needs: build-cross-arch
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 物理清理旧 release 目录
        run: |
          # 彻底删除旧文件夹及旧文件，确保存储库干净
          rm -rf release/
          mkdir -p release/

      - name: 下载 amd64 二进制
        uses: actions/download-artifact@v4
        with:
          name: binary_amd64
          path: release/

      - name: 下载 arm64 二进制
        uses: actions/download-artifact@v4
        with:
          name: binary_arm64
          path: release/

      - name: 推送产物
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add release/
          if git diff --cached --quiet; then
            echo "⚠️ 没有文件变化"
          else
            git commit -m "chore: 更新单文件二进制产物 $(date +%Y%m%d_%H%M%S)"
            git push origin main
          fi