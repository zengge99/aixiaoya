name: 打包成一个文件
on:
  workflow_dispatch:

jobs:
  # ========== 第一阶段：前置导出公共资源 (ONNX/Vocab) ==========
  prepare-assets:
    name: 导出公共模型资源
    runs-on: ubuntu-latest
    outputs:
      artifact-name: common-assets
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装导出环境
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends python3-pip
          pip install --upgrade pip setuptools wheel
          pip install --no-cache-dir --only-binary=all torch tqdm numpy onnxscript onnxruntime

      - name: 执行导出脚本
        run: |
          python export_onnx.py
          mkdir -p ./common_files
          # 移动所有必要资源
          cp movie_extractor.onnx* ./common_files/
          cp vocab.pkl ./common_files/
          ls -l ./common_files/

      - name: 上传公共资源
        uses: actions/upload-artifact@v4
        with:
          name: common-assets
          path: ./common_files/
          retention-days: 1

  # ========== 第二阶段：并行构建各架构产物 ==========
  build-cross-arch:
    name: 构建 ${{ matrix.arch }} 架构
    runs-on: ubuntu-latest
    needs: prepare-assets
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 下载公共模型资源
        uses: actions/download-artifact@v4
        with:
          name: common-assets
          path: ./common_files

      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 安装QEMU支持
        uses: docker/setup-qemu-action@v3

      - name: 跨架构打包 (资源内嵌)
        run: |
          # 创建 Dockerfile
          cat > Dockerfile.${{ matrix.arch }} << EOF
          FROM python:3.12-slim AS builder
          WORKDIR /app
          
          RUN apt-get update && apt-get install -y --no-install-recommends \
              gcc g++ && rm -rf /var/lib/apt/lists/*
          
          RUN pip install --upgrade pip setuptools wheel
          RUN pip install --no-cache-dir --only-binary=all onnxruntime pyinstaller
          
          COPY . .
          # 将资源移动到当前目录以便 PyInstaller 打包
          COPY ./common_files/* . 

          # 核心修改：使用 --add-data 将资源打包进单执行文件
          # 注意：Linux 下 PyInstaller 的 add-data 分隔符是冒号 ":"
          # 格式为 "源文件:目标内部路径"
          RUN pyinstaller --onefile --clean \
              --name movie_extractor \
              --add-data "movie_extractor.onnx:." \
              --add-data "movie_extractor.onnx.data:." \
              --add-data "vocab.pkl:." \
              infer_onnx.py

          # 导出阶段
          FROM scratch AS export-stage
          ARG ARCH
          COPY --from=builder /app/dist/movie_extractor /${{ matrix.arch }}/movie_extractor
          EOF

          # 执行构建
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f Dockerfile.${{ matrix.arch }} \
            --target export-stage \
            --output type=local,dest=./output \
            --load .

      - name: 上传单二进制产物
        uses: actions/upload-artifact@v4
        with:
          name: binary_${{ matrix.arch }}
          path: output/${{ matrix.arch }}/movie_extractor
          retention-days: 1

  # ========== 第三阶段：合并、打包并提交 ==========
  deploy:
    name: 打包并推送
    runs-on: ubuntu-latest
    needs: build-cross-arch
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 彻底物理清理 release 目录 (杜绝重复文件)
        run: |
          rm -rf release/
          mkdir -p release/amd64 release/arm64

      - name: 下载构建好的二进制
        uses: actions/download-artifact@v4
        with:
          name: binary_amd64
          path: release/amd64

      - name: 下载构建好的二进制
        uses: actions/download-artifact@v4
        with:
          name: binary_arm64
          path: release/arm64

      - name: 生成ZIP包
        run: |
          cd release
          # 删除旧的 zip（如果 checkout 带下来的话）
          rm -f *.zip
          
          # 因为资源已内嵌，压缩包现在只包含一个二进制文件
          # 使用 -j 标志让解压后直接是文件
          zip -j movie_extractor_amd64.zip amd64/movie_extractor
          zip -j movie_extractor_arm64.zip arm64/movie_extractor
          
          echo "检查最终目录结构："
          ls -R
        shell: bash

      - name: 推送产物到仓库
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 先同步远程状态，防止冲突
          git pull origin main --rebase
          
          git add release/
          if git diff --cached --quiet; then
            echo "⚠️  无内容变化"
          else
            git commit -m "chore: 自动打包内嵌资源二进制 $(date +%Y%m%m_%H%M%S)"
            git push origin main
          fi
        shell: bash